{"ast":null,"code":"import { ActivatedRouteSnapshot, RouterStateSnapshot, Router } from '@angular/router';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nexport var UserRole;\n(function (UserRole) {\n  UserRole[\"ADMIN_ORG\"] = \"admin_org\";\n  UserRole[\"GERENTE_FINANCEIRO\"] = \"gerente_financeiro\";\n  UserRole[\"CONTABILIDADE\"] = \"contabilidade\";\n  UserRole[\"AUDITOR_EXTERNO\"] = \"auditor_externo\";\n  UserRole[\"CLIENTE\"] = \"cliente\";\n})(UserRole || (UserRole = {}));\nexport class RBACGuard {\n  constructor(authService, router) {\n    this.authService = authService;\n    this.router = router;\n  }\n  canActivate(route, state) {\n    const user = this.authService.getCurrentUser();\n    if (!user) {\n      this.router.navigate(['/login']);\n      return false;\n    }\n    const requiredRoles = route.data['roles'];\n    const requiredPermissions = route.data['permissions'];\n    if (requiredRoles && !this.hasRole(user.role, requiredRoles)) {\n      this.router.navigate(['/unauthorized']);\n      return false;\n    }\n    if (requiredPermissions && !this.hasPermissions(user.role, requiredPermissions)) {\n      this.router.navigate(['/unauthorized']);\n      return false;\n    }\n    return true;\n  }\n  hasRole(userRole, requiredRoles) {\n    return requiredRoles.includes(userRole) || userRole === UserRole.ADMIN_ORG;\n  }\n  hasPermissions(userRole, requiredPermissions) {\n    const rolePermissions = this.getRolePermissions(userRole);\n    if (rolePermissions.includes('*')) return true;\n    return requiredPermissions.every(permission => rolePermissions.includes(permission) || rolePermissions.includes(permission.split(':')[0] + ':*'));\n  }\n  getRolePermissions(role) {\n    const permissions = {\n      [UserRole.ADMIN_ORG]: ['*'],\n      [UserRole.GERENTE_FINANCEIRO]: ['ifrs15:read', 'ifrs15:write', 'policies:read', 'policies:write', 'contracts:read', 'contracts:write', 'revenue:read', 'revenue:write', 'dac:read', 'dac:write', 'reports:read'],\n      [UserRole.CONTABILIDADE]: ['contracts:read', 'contracts:write', 'contracts:reestimate', 'revenue:read', 'revenue:write', 'revenue:reprocess', 'dac:read', 'dac:write', 'invoicing:read', 'invoicing:write', 'reports:read'],\n      [UserRole.AUDITOR_EXTERNO]: ['contracts:read', 'revenue:read', 'dac:read', 'policies:read', 'reports:read', 'snapshots:read', 'audit:read'],\n      [UserRole.CLIENTE]: ['contracts:read:own', 'revenue:read:own', 'invoices:read:own', 'reports:read:own']\n    };\n    return permissions[role] || [];\n  }\n  static {\n    this.ɵfac = function RBACGuard_Factory(t) {\n      return new (t || RBACGuard)(i0.ɵɵinject(AuthService), i0.ɵɵinject(i1.Router));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: RBACGuard,\n      factory: RBACGuard.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}\nexport class AuthService {\n  constructor() {\n    this.currentUser = null;\n    this.loadUserFromStorage();\n  }\n  getCurrentUser() {\n    return this.currentUser;\n  }\n  setCurrentUser(user) {\n    this.currentUser = user;\n    localStorage.setItem('current_user', JSON.stringify(user));\n  }\n  logout() {\n    this.currentUser = null;\n    localStorage.removeItem('current_user');\n    localStorage.removeItem('access_token');\n  }\n  loadUserFromStorage() {\n    const userData = localStorage.getItem('current_user');\n    if (userData) {\n      this.currentUser = JSON.parse(userData);\n    }\n  }\n  hasRole(role) {\n    return this.currentUser?.role === role || this.currentUser?.role === UserRole.ADMIN_ORG;\n  }\n  hasPermission(permission) {\n    if (!this.currentUser) return false;\n    const guard = new RBACGuard(this, null);\n    return guard.hasPermissions(this.currentUser.role, [permission]);\n  }\n  static {\n    this.ɵfac = function AuthService_Factory(t) {\n      return new (t || AuthService)();\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: AuthService,\n      factory: AuthService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["ActivatedRouteSnapshot","RouterStateSnapshot","Router","UserRole","RBACGuard","constructor","authService","router","canActivate","route","state","user","getCurrentUser","navigate","requiredRoles","data","requiredPermissions","hasRole","role","hasPermissions","userRole","includes","ADMIN_ORG","rolePermissions","getRolePermissions","every","permission","split","permissions","GERENTE_FINANCEIRO","CONTABILIDADE","AUDITOR_EXTERNO","CLIENTE","i0","ɵɵinject","AuthService","i1","factory","ɵfac","providedIn","currentUser","loadUserFromStorage","setCurrentUser","localStorage","setItem","JSON","stringify","logout","removeItem","userData","getItem","parse","hasPermission","guard"],"sources":["C:\\Projetos\\IFRS 15\\apps\\web\\src\\app\\shared\\guards\\rbac.guard.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router } from '@angular/router';\nimport { Observable } from 'rxjs';\n\nexport enum UserRole {\n  ADMIN_ORG = 'admin_org',\n  GERENTE_FINANCEIRO = 'gerente_financeiro',\n  CONTABILIDADE = 'contabilidade',\n  AUDITOR_EXTERNO = 'auditor_externo',\n  CLIENTE = 'cliente'\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RBACGuard implements CanActivate {\n  constructor(\n    private authService: AuthService,\n    private router: Router\n  ) {}\n\n  canActivate(\n    route: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean> | Promise<boolean> | boolean {\n    const user = this.authService.getCurrentUser();\n    \n    if (!user) {\n      this.router.navigate(['/login']);\n      return false;\n    }\n\n    const requiredRoles = route.data['roles'] as UserRole[];\n    const requiredPermissions = route.data['permissions'] as string[];\n\n    if (requiredRoles && !this.hasRole(user.role, requiredRoles)) {\n      this.router.navigate(['/unauthorized']);\n      return false;\n    }\n\n    if (requiredPermissions && !this.hasPermissions(user.role, requiredPermissions)) {\n      this.router.navigate(['/unauthorized']);\n      return false;\n    }\n\n    return true;\n  }\n\n  private hasRole(userRole: UserRole, requiredRoles: UserRole[]): boolean {\n    return requiredRoles.includes(userRole) || userRole === UserRole.ADMIN_ORG;\n  }\n\n  private hasPermissions(userRole: UserRole, requiredPermissions: string[]): boolean {\n    const rolePermissions = this.getRolePermissions(userRole);\n    \n    if (rolePermissions.includes('*')) return true;\n    \n    return requiredPermissions.every(permission => \n      rolePermissions.includes(permission) || \n      rolePermissions.includes(permission.split(':')[0] + ':*')\n    );\n  }\n\n  private getRolePermissions(role: UserRole): string[] {\n    const permissions = {\n      [UserRole.ADMIN_ORG]: ['*'],\n      [UserRole.GERENTE_FINANCEIRO]: [\n        'ifrs15:read', 'ifrs15:write', 'policies:read', 'policies:write',\n        'contracts:read', 'contracts:write', 'revenue:read', 'revenue:write',\n        'dac:read', 'dac:write', 'reports:read'\n      ],\n      [UserRole.CONTABILIDADE]: [\n        'contracts:read', 'contracts:write', 'contracts:reestimate',\n        'revenue:read', 'revenue:write', 'revenue:reprocess',\n        'dac:read', 'dac:write', 'invoicing:read', 'invoicing:write',\n        'reports:read'\n      ],\n      [UserRole.AUDITOR_EXTERNO]: [\n        'contracts:read', 'revenue:read', 'dac:read', 'policies:read',\n        'reports:read', 'snapshots:read', 'audit:read'\n      ],\n      [UserRole.CLIENTE]: [\n        'contracts:read:own', 'revenue:read:own', 'invoices:read:own',\n        'reports:read:own'\n      ]\n    };\n\n    return permissions[role] || [];\n  }\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AuthService {\n  private currentUser: any = null;\n\n  constructor() {\n    this.loadUserFromStorage();\n  }\n\n  getCurrentUser(): any {\n    return this.currentUser;\n  }\n\n  setCurrentUser(user: any): void {\n    this.currentUser = user;\n    localStorage.setItem('current_user', JSON.stringify(user));\n  }\n\n  logout(): void {\n    this.currentUser = null;\n    localStorage.removeItem('current_user');\n    localStorage.removeItem('access_token');\n  }\n\n  private loadUserFromStorage(): void {\n    const userData = localStorage.getItem('current_user');\n    if (userData) {\n      this.currentUser = JSON.parse(userData);\n    }\n  }\n\n  hasRole(role: UserRole): boolean {\n    return this.currentUser?.role === role || this.currentUser?.role === UserRole.ADMIN_ORG;\n  }\n\n  hasPermission(permission: string): boolean {\n    if (!this.currentUser) return false;\n    \n    const guard = new RBACGuard(this, null as any);\n    return (guard as any).hasPermissions(this.currentUser.role, [permission]);\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}